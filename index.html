<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Crowd Monitoring Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #0f172a;
    color: white;
    text-align: center;
    padding: 20px;
}

h1 {
    margin-bottom: 20px;
}

.dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.card {
    background: #1e293b;
    padding: 20px;
    border-radius: 10px;
}

.status { color: #10b981; }
.status.warning { color: #f59e0b; }
.status.danger { color: #ef4444; }

button {
    padding: 10px 20px;
    margin: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}
</style>
</head>

<body>

<h1>üéØ Smart Crowd Monitoring Dashboard</h1>

<div class="dashboard">
    <div class="card">
        <h3>Current Crowd</h3>
        <h2 id="crowdCount">0</h2>
    </div>

    <div class="card">
        <h3>Status</h3>
        <h2 id="crowdStatus" class="status">Normal</h2>
    </div>

    <div class="card">
        <h3>Peak Today</h3>
        <h2 id="peakCount">0</h2>
    </div>

    <div class="card">
        <h3>Average</h3>
        <h2 id="avgCount">0</h2>
    </div>
</div>

<button onclick="pauseMonitoring()">
    <span id="pauseIcon">‚è∏Ô∏è</span>
    <span id="pauseText">Pause</span>
</button>

<canvas id="crowdChart"></canvas>

<script>
let crowdData = [];
let labels = [];
let previousCount = 0;
let peakCount = 0;
let allCounts = [];
let isPaused = false;

const updateInterval = 5000;
const moderateThreshold = 50;
const crowdedThreshold = 80;

const ctx = document.getElementById("crowdChart").getContext("2d");
const crowdChart = new Chart(ctx, {
    type: "line",
    data: {
        labels: labels,
        datasets: [{
            label: "Crowd Count",
            data: crowdData,
            borderColor: "#667eea",
            backgroundColor: "rgba(102,126,234,0.2)",
            borderWidth: 3,
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
    }
});

function getStatus(count) {
    if (count < moderateThreshold)
        return { text: "Normal", class: "status" };
    if (count < crowdedThreshold)
        return { text: "Moderate", class: "status warning" };
    return { text: "Crowded", class: "status danger" };
}

function getCurrentTime() {
    return new Date().toLocaleTimeString();
}

async function updateDashboard() {
    if (isPaused) return;

    try {
        const response = await fetch("https://project-8eg3.onrender.com/api/dashboard");

        if (!response.ok) throw new Error("Server error");

        const data = await response.json();

        const newCount = data.deviceCount || data.crowdCount || 0;

        document.getElementById("crowdCount").textContent = newCount;

        const status = getStatus(newCount);
        const statusElement = document.getElementById("crowdStatus");
        statusElement.textContent = status.text;
        statusElement.className = status.class;

        if (newCount > peakCount) {
            peakCount = newCount;
            document.getElementById("peakCount").textContent = peakCount;
        }

        allCounts.push(newCount);
        const avg = Math.round(allCounts.reduce((a,b)=>a+b,0)/allCounts.length);
        document.getElementById("avgCount").textContent = avg;

        crowdData.push(newCount);
        labels.push(getCurrentTime());

        if (crowdData.length > 20) {
            crowdData.shift();
            labels.shift();
        }

        crowdChart.update();

        previousCount = newCount;

    } catch (err) {
        console.error("Backend connection failed:", err);
        document.getElementById("crowdStatus").textContent = "Server Offline";
        document.getElementById("crowdStatus").className = "status danger";
    }
}

function pauseMonitoring() {
    isPaused = !isPaused;
    document.getElementById("pauseText").textContent = isPaused ? "Resume" : "Pause";
    document.getElementById("pauseIcon").textContent = isPaused ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è";
}

updateDashboard();
setInterval(updateDashboard, updateInterval);
</script>

</body>
</html>
